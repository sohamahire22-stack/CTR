<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>CTR Thumbnail Gen (Real Face)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <style>
    /* Dark CTR Theme */
    body { font-family: 'Arial', sans-serif; background: #0f172a; color: #e5e7eb; margin: 0; padding: 20px; }
    .container { max-width: 800px; margin: auto; }
    
    /* Controls */
    .card { background: #1e293b; padding: 20px; border-radius: 12px; margin-bottom: 20px; border: 1px solid #334155; }
    label { font-weight: bold; color: #94a3b8; font-size: 0.9em; display: block; margin-top: 10px; }
    input, select { width: 100%; padding: 12px; margin-top: 5px; background: #0f172a; border: 1px solid #475569; color: white; border-radius: 6px; box-sizing: border-box; }
    
    /* File Upload Styling */
    .file-upload { border: 2px dashed #4f46e5; padding: 20px; text-align: center; border-radius: 8px; margin-top: 10px; cursor: pointer; }
    .file-upload:hover { background: #1e1b4b; }
    
    button { width: 100%; padding: 15px; margin-top: 20px; background: #6366f1; color: white; border: none; border-radius: 8px; font-weight: bold; font-size: 16px; cursor: pointer; }
    button:disabled { background: #475569; cursor: wait; }

    /* Canvas for Real-Time Design */
    .canvas-container {
        display: none;
        margin-top: 20px;
        border: 2px solid #475569;
        border-radius: 8px;
        overflow: hidden;
        box-shadow: 0 10px 30px rgba(0,0,0,0.5);
    }
    canvas { width: 100%; display: block; }
  </style>
</head>
<body>

<div class="container">
  <h1>CTR Engine (With Real Face)</h1>
  <p>Generates rule-based backgrounds + layers your real photo.</p>

  <div class="card">
    <label>Video Title</label>
    <input id="title" placeholder="e.g. How to Score 95% in Boards">

    <label>Topic / Subject</label>
    <input id="topic" placeholder="e.g. Math Exam">

    <div style="display: flex; gap: 10px;">
        <div style="flex:1">
            <label>Urgency</label>
            <select id="urgency">
                <option>Normal</option>
                <option>Exam Soon</option>
                <option>Result Phase</option>
            </select>
        </div>
        <div style="flex:1">
            <label>Creator Personality</label>
            <select id="personality">
                <option>Authority (Teacher)</option>
                <option>Energetic (Bhaiya/Didi)</option>
                <option>Calm (Guide)</option>
            </select>
        </div>
    </div>

    <label>Your Photo (Optional)</label>
    <div class="file-upload" onclick="document.getElementById('userFace').click()">
        <span id="fileName">Click to upload Face (PNG/Cutout recommended)</span>
        <input type="file" id="userFace" accept="image/*" style="display: none" onchange="updateFileName(this)">
    </div>

    <button id="btn" onclick="generateThumbnail()">Generate Thumbnail</button>
  </div>

  <div class="canvas-container" id="outputArea">
    <canvas id="thumbCanvas" width="1280" height="720"></canvas>
    <p style="text-align: center; color: #94a3b8; padding: 10px;">Right-click image to Save As...</p>
  </div>
</div>

<script>
function updateFileName(input) {
    if(input.files && input.files[0]) {
        document.getElementById('fileName').innerText = "âœ… Selected: " + input.files[0].name;
    }
}

async function generateThumbnail() {
    const btn = document.getElementById("btn");
    const outputArea = document.getElementById("outputArea");
    const canvas = document.getElementById("thumbCanvas");
    const ctx = canvas.getContext("2d");

    // 1. Prepare UI
    btn.innerText = "Analyzing Logic & Generating Background...";
    btn.disabled = true;
    outputArea.style.display = "block";
    
    // Clear canvas
    ctx.fillStyle = "#020617";
    ctx.fillRect(0,0, 1280, 720);
    ctx.fillStyle = "white";
    ctx.font = "30px Arial";
    ctx.fillText("Generating AI Background...", 500, 360);

    const hasFace = document.getElementById("userFace").files.length > 0 ? "Yes" : "No";

    try {
        // 2. Call Worker for Logic + Background Image
        const res = await fetch("https://ctr-thumbnail-brain.sohamahire22.workers.dev", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
                title: document.getElementById("title").value,
                topic: document.getElementById("topic").value,
                urgency: document.getElementById("urgency").value,
                personality: document.getElementById("personality").value,
                face: hasFace
            })
        });
        const data = await res.json();

        // 3. Draw AI Background
        const bgImg = new Image();
        bgImg.src = data.image; // Base64 from worker
        await new Promise(r => bgImg.onload = r);
        ctx.drawImage(bgImg, 0, 0, 1280, 720);

        // 4. Draw User Face (If uploaded)
        if (hasFace === "Yes") {
            const userFile = document.getElementById("userFace").files[0];
            const reader = new FileReader();
            reader.readAsDataURL(userFile);
            await new Promise(resolve => {
                reader.onload = async (e) => {
                    const userImg = new Image();
                    userImg.src = e.target.result;
                    await new Promise(r => userImg.onload = r);
                    
                    // Logic: Place face on LEFT (1/3rd rule) roughly
                    // Maintain aspect ratio, max height 90% of thumbnail
                    const h = 720 * 0.9;
                    const w = userImg.width * (h / userImg.height);
                    
                    // Draw face at bottom left
                    ctx.drawImage(userImg, 50, 720 - h, w, h);
                    resolve();
                };
            });
        }

        // 5. Draw CTR Text (Overlay)
        // Style: Big, Impact font, Stroke, Shadow
        ctx.font = "900 130px Impact"; // Big bold font
        ctx.textAlign = "right";
        ctx.fillStyle = data.text_color;
        ctx.strokeStyle = "black";
        ctx.lineWidth = 8;
        
        // Shadow for contrast
        ctx.shadowColor = "rgba(0,0,0,0.8)";
        ctx.shadowBlur = 15;
        ctx.shadowOffsetX = 5;
        ctx.shadowOffsetY = 5;

        // Position: Top Right (to balance face on left)
        // We split text into lines if needed, but rule says 1-3 words so usually 1 line
        const textX = 1200;
        const textY = 360; // Center vertical-ish

        ctx.strokeText(data.text, textX, textY);
        ctx.fillText(data.text, textX, textY);

        // Add "Check" or "Visual" if provided (Simple shapes could be added here later)

    } catch (e) {
        alert("Error: " + e.message);
        console.error(e);
    } finally {
        btn.innerText = "Generate Thumbnail";
        btn.disabled = false;
    }
}
</script>

</body>
</html>
