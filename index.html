<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>CTR Thumbnail Gen (Real Face)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <style>
    /* Dark CTR Theme */
    body { font-family: 'Arial', sans-serif; background: #0f172a; color: #e5e7eb; margin: 0; padding: 20px; }
    .container { max-width: 800px; margin: auto; }
    
    /* Controls */
    .card { background: #1e293b; padding: 20px; border-radius: 12px; margin-bottom: 20px; border: 1px solid #334155; }
    label { font-weight: bold; color: #94a3b8; font-size: 0.9em; display: block; margin-top: 10px; }
    input, select { width: 100%; padding: 12px; margin-top: 5px; background: #0f172a; border: 1px solid #475569; color: white; border-radius: 6px; box-sizing: border-box; }
    
    /* File Upload Styling */
    .file-upload { border: 2px dashed #4f46e5; padding: 20px; text-align: center; border-radius: 8px; margin-top: 10px; cursor: pointer; }
    .file-upload:hover { background: #1e1b4b; }
    
    button { width: 100%; padding: 15px; margin-top: 20px; background: #6366f1; color: white; border: none; border-radius: 8px; font-weight: bold; font-size: 16px; cursor: pointer; }
    button:disabled { background: #475569; cursor: wait; }

    /* Canvas for Real-Time Design */
    .canvas-container {
        display: none;
        margin-top: 20px;
        border: 2px solid #475569;
        border-radius: 8px;
        overflow: hidden;
        box-shadow: 0 10px 30px rgba(0,0,0,0.5);
    }
    canvas { width: 100%; display: block; }

    /* Loading/Error Overlay */
    #statusOverlay {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0,0,0,0.7);
        display: none;
        justify-content: center;
        align-items: center;
        color: yellow;
        font-size: 20px;
        text-align: center;
        padding: 20px;
        box-sizing: border-box;
    }
  </style>
</head>
<body>

<div class="container">
  <h1>CTR Engine (With Real Face)</h1>
  <p>Generates rule-based backgrounds + layers your real photo.</p>

  <div class="card">
    <label>Video Title</label>
    <input id="title" placeholder="e.g. How to Score 95% in Boards">

    <label>Topic / Subject</label>
    <input id="topic" placeholder="e.g. Math Exam">

    <div style="display: flex; gap: 10px;">
        <div style="flex:1">
            <label>Urgency</label>
            <select id="urgency">
                <option>Normal</option>
                <option>Exam Soon</option>
                <option>Result Phase</option>
            </select>
        </div>
        <div style="flex:1">
            <label>Creator Personality</label>
            <select id="personality">
                <option>Authority (Teacher)</option>
                <option>Energetic (Bhaiya/Didi)</option>
                <option>Calm (Guide)</option>
            </select>
        </div>
    </div>

    <label>Your Photo (Optional)</label>
    <div class="file-upload" onclick="document.getElementById('userFace').click()">
        <span id="fileName">Click to upload Face (PNG/Cutout recommended)</span>
        <input type="file" id="userFace" accept="image/*" style="display: none" onchange="updateFileName(this)">
    </div>

    <button id="btn" onclick="generateThumbnail()">Generate Thumbnail</button>
  </div>

  <div class="canvas-container" id="outputArea" style="position: relative;">
    <canvas id="thumbCanvas" width="1280" height="720"></canvas>
    <div id="statusOverlay"></div>
    <p style="text-align: center; color: #94a3b8; padding: 10px;">Right-click image to Save As...</p>
  </div>
</div>

<script>
function updateFileName(input) {
    if(input.files && input.files[0]) {
        document.getElementById('fileName').innerText = "✅ Selected: " + input.files[0].name;
    } else {
         document.getElementById('fileName').innerText = "Click to upload Face (PNG/Cutout recommended)";
    }
}

async function generateThumbnail() {
    const btn = document.getElementById("btn");
    const outputArea = document.getElementById("outputArea");
    const canvas = document.getElementById("thumbCanvas");
    const ctx = canvas.getContext("2d");
    const statusOverlay = document.getElementById("statusOverlay");

    // 1. Prepare UI
    btn.disabled = true;
    outputArea.style.display = "block";
    statusOverlay.style.display = "flex";
    
    // Clear canvas and set initial loading state
    ctx.fillStyle = "#020617";
    ctx.fillRect(0,0, 1280, 720);
    ctx.fillStyle = "white";
    ctx.font = "30px Arial";
    ctx.textAlign = "center";
    ctx.fillText("Sending request to CTR Engine...", 640, 360);
    statusOverlay.innerText = "Analyzing Logic & Requesting AI Models...";
    
    const hasFace = document.getElementById("userFace").files.length > 0 ? "Yes" : "No";

    try { // ... (start of async fetch)

  
        let requestBody;
        try {
            requestBody = await request.json();
        } catch (e) {
            // This catches a scenario where the browser sends a bad JSON payload
            throw new Error("Failed to parse request body as JSON. Check your fetch headers.");
        }
        // Destructure from the successfully parsed body
        const { title, topic, urgency, personality, face } = requestBody;
        // --- END CRITICAL DEBUG CHECK ---
        
        const videoIntent = classifyIntent(title);
        const hasUserFace = (face === "Yes");
        
        // ... (rest of the logic remains the same)
        // 2. Call Worker for Logic + Background Image
        const res = await fetch("[https://ctr-thumbnail-brain.sohamahire22.workers.dev](https://ctr-thumbnail-brain.sohamahire22.workers.dev)", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
                title: document.getElementById("title").value,
                topic: document.getElementById("topic").value,
                urgency: document.getElementById("urgency").value,
                personality: document.getElementById("personality").value,
                face: hasFace
            })
        });
        
        // --- CRITICAL CHECK FOR 500/CORS FAILURE ---
        if (!res.ok) {
            let errorText = `HTTP Error ${res.status}. Check Console for details.`;
            try {
                const errorData = await res.json();
                errorText = errorData.message || errorText;
            } catch (e) {
                errorText = `Critical Crash: Worker failed with status ${res.status}. AI Model call failed. Check Cloudflare Logs!`;
            }
            throw new Error(errorText); // Jumps to catch block
        }
        
        const data = await res.json();
        statusOverlay.innerText = "✅ AI Background Received. Compositing your face...";

        // 3. Draw AI Background
        const bgImg = new Image();
        bgImg.src = data.image; // Base64 from worker
        await new Promise(r => bgImg.onload = r);
        ctx.drawImage(bgImg, 0, 0, 1280, 720);
        
        statusOverlay.innerText = "Drawing Text Overlay...";

        // 4. Draw User Face (If uploaded)
        if (hasFace === "Yes") {
            const userFile = document.getElementById("userFace").files[0];
            const reader = new FileReader();
            reader.readAsDataURL(userFile);
            await new Promise(resolve => {
                reader.onload = async (e) => {
                    const userImg = new Image();
                    userImg.src = e.target.result;
                    await new Promise(r => userImg.onload = r);
                    
                    // Logic: Place face on LEFT (1/3rd rule)
                    const h = 720 * 0.9;
                    const w = userImg.width * (h / userImg.height);
                    
                    // Draw face at bottom left, 50px margin
                    ctx.drawImage(userImg, 50, 720 - h, w, h);
                    resolve();
                };
            });
            statusOverlay.innerText = "Drawing Text Overlay...";
        }

        // 5. Draw CTR Text (Overlay)
        ctx.font = "900 130px Impact"; // Big bold font
        ctx.textAlign = "right";
        ctx.fillStyle = data.text_color;
        ctx.strokeStyle = "black";
        ctx.lineWidth = 10;
        
        [cite_start]// Shadow for contrast and prominence [cite: 174]
        ctx.shadowColor = "rgba(0,0,0,0.8)";
        ctx.shadowBlur = 15;
        ctx.shadowOffsetX = 5;
        ctx.shadowOffsetY = 5;

        // Position: Top Right (to balance face on left, 80px margin)
        const textX = 1200;
        const textY = 360; 

        ctx.strokeText(data.text, textX, textY);
        ctx.fillText(data.text, textX, textY);
        
        statusOverlay.style.display = "none"; // Hide overlay on success

    } catch (e) {
        // Display the error on the canvas overlay
        ctx.fillStyle = "#FF0000";
        ctx.font = "40px Arial";
        ctx.textAlign = "center";
        ctx.fillRect(0,0, 1280, 720);
        
        statusOverlay.style.display = "flex";
        statusOverlay.style.backgroundColor = "rgba(255, 0, 0, 0.8)";
        statusOverlay.innerText = "Error Generating Thumbnail:\n\n" + e.message;
        
        console.error("Fatal Generation Error:", e);
    } finally {
        btn.innerText = "Generate Thumbnail";
        btn.disabled = false;
        // statusOverlay is hidden on success, or updated on failure.
    }
}
</script>

</body>
</html>
